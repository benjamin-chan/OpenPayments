---
title: "CMS Open Payments"
author: "Benjamin Chan (chanb@ohsu.edu)"
output:
  html_document:
    keep_md: yes
    toc: yes
---

**Play around with the CMS [Open Payments](http://www.cms.gov/OpenPayments) data.**

`r Sys.Date()`

`r R.Version()$version.string`

Download the data dictionary.

```{r}
url <- "http://www.cms.gov/OpenPayments/Downloads/OpenPaymentsDataDictionary.pdf"
download.file(url, paste0(getwd(), "\\OpenPaymentsDataDictionary.pdf"), mode="wb")
```

Download the *Datasets containing all records with identifying information on covered recipients* file.

```{r}
url <- "http://download.cms.gov/openpayments/09302014_ALLDTL.ZIP"
f <- paste0(tempfile(), ".zip")
download.file(url, f, mode="wb")
```

Unzip the file.

```{r}
unzip(f, exdir=tempdir())
filenames <- unzip(f, list=TRUE)
filenames
```

Show the `README.txt` file.

```{r}
cat(readLines(paste0(tempdir(), "\\README.txt")), sep="\n")
```

Define helper functions.

```{r}
niceTable <- function (dt) {
  require(xtable)
  print(xtable(dt), type="html", include.rownames=FALSE)
}
```

# General Payments

**General Payments are defined as payments or other transfers of value not made in connection with a research agreement or research protocol.**

Read the General Payments file into a data table.
See *Appendix A: General Payments Detail* in [OpenPaymentsDataDictionary.pdf](http://www.cms.gov/OpenPayments/Downloads/OpenPaymentsDataDictionary.pdf).

```{r}
f <- filenames$Name[grep("GNRL", filenames$Name)]
f <- paste0(tempdir(), "\\", f)
require(data.table)
colNames <- names(fread(f, nrows=0))
classes <- list(character=1:length(colNames))
D <- fread(f,
           colClasses=classes,
           na.strings="",
           stringsAsFactors=FALSE)
```

Recode dates and numeric columns.

```{r}
colNames[grep("Date", colNames)]
D <- D[,
       `:=` (Program_Year = as.integer(Program_Year),
             Payment_Publication_Date = as.Date(Payment_Publication_Date, format="%m/%d/%Y"),
             Date_of_Payment = as.Date(Date_of_Payment, format="%m/%d/%Y"),
             Total_Amount_of_Payment_USDollars = as.numeric(Total_Amount_of_Payment_USDollars),
             Number_of_Payments_Included_in_Total_Amount = as.integer(Number_of_Payments_Included_in_Total_Amount))]
```

Find the 10 largest payments.

```{r, results='asis'}
topPayments <- sort(D[, Total_Amount_of_Payment_USDollars], decreasing=TRUE)[1:10]
top <- D[Total_Amount_of_Payment_USDollars %in% topPayments,
         list(Total_Amount_of_Payment_USDollars,
              Date_of_Payment,
              Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name,
              Physician_First_Name,
              Physician_Last_Name,
              Teaching_Hospital_Name,
              Recipient_City,
              Recipient_State,
              Recipient_Postal_Code,
              Name_of_Associated_Covered_Drug_or_Biological1,
              Form_of_Payment_or_Transfer_of_Value,
              Nature_of_Payment_or_Transfer_of_Value)][order(Total_Amount_of_Payment_USDollars, decreasing=TRUE)]
niceTable(top)
```

How many unique drugs or biologicals are represented?

```{r}
setkey(D, Name_of_Associated_Covered_Drug_or_Biological1)
length(unique(D[, Name_of_Associated_Covered_Drug_or_Biological1]))
```

List the drugs or biologicals with more than $1M in total payments.

```{r, results='asis'}
drugs <- D[,
           list(sumPayments = sum(Total_Amount_of_Payment_USDollars),
                nRecords = .N),
           Name_of_Associated_Covered_Drug_or_Biological1][order(sumPayments, decreasing=TRUE)]
niceTable(drugs[sumPayments > 1E6])
```

List the teaching hospitals with more than $1M in total payments.

```{r, results='asis'}
hosps <- D[grep("Teaching Hospital", Covered_Recipient_Type),
           list(sumPayments = sum(Total_Amount_of_Payment_USDollars),
                nRecords = .N),
           list(Teaching_Hospital_Name, Recipient_City, Recipient_State)][order(sumPayments, decreasing=TRUE)]
niceTable(hosps[sumPayments > 1E6])
```

List the physicians with more than $1M in total payments.

```{r, results='asis'}
docs <- D[grep("Physician", Covered_Recipient_Type),
          list(sumPayments = sum(Total_Amount_of_Payment_USDollars),
               nRecords = .N),
          list(Physician_Last_Name, Physician_First_Name, Recipient_City, Recipient_State)][order(sumPayments, decreasing=TRUE)]
niceTable(docs[sumPayments > 1E6])
```

List the payments to OHSU.

```{r, results='asis'}
ohsu <- D[grep("Oregon Health & Science University", Teaching_Hospital_Name),
          list(sumPayments = sum(Total_Amount_of_Payment_USDollars),
               nRecords = .N),
          list(Teaching_Hospital_Name)]
niceTable(ohsu)
```


# Research Payments

**Research Payments are defined as payments or other transfers of value made in connection with a research agreement or research protocol.**

Read the Research Payments file into a data table.
See *Appendix B: Research Payments Detail* in [OpenPaymentsDataDictionary.pdf](http://www.cms.gov/OpenPayments/Downloads/OpenPaymentsDataDictionary.pdf).

```{r}
f <- filenames$Name[grep("RSRCH", filenames$Name)]
f <- paste0(tempdir(), "\\", f)
require(data.table)
colNames <- names(fread(f, nrows=0))
classes <- list(character=1:length(colNames))
D <- fread(f,
           colClasses=classes,
           na.strings="",
           stringsAsFactors=FALSE)
```

Recode dates and numeric columns.

```{r}
colNames[grep("Date", colNames)]
D <- D[,
       `:=` (Program_Year = as.integer(Program_Year),
             Payment_Publication_Date = as.Date(Payment_Publication_Date, format="%m/%d/%Y"),
             Date_of_Payment = as.Date(Date_of_Payment, format="%m/%d/%Y"),
             Total_Amount_of_Payment_USDollars = as.numeric(Total_Amount_of_Payment_USDollars))]
```

List the principal investigators with more than $1M in total payments.

```{r, results='asis'}
pis <- D[,
         list(sumPayments = sum(Total_Amount_of_Payment_USDollars),
              nRecords = .N),
         list(Principal_Investigator_Name1, Teaching_Hospital_Name, Recipient_City, Recipient_State)][order(sumPayments, decreasing=TRUE)]
niceTable(pis[sumPayments > 1E6])
```

List the payments to OHSU.

```{r, results='asis'}
ohsu <- D[grep("Oregon Health & Science University", Teaching_Hospital_Name),
          list(sumPayments = sum(Total_Amount_of_Payment_USDollars),
               nRecords = .N),
          list(Principal_Investigator_Name1, Teaching_Hospital_Name)][order(sumPayments, decreasing=TRUE)]
niceTable(ohsu)
```
